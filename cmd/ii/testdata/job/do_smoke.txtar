# setup repo
mkdir repo
cd repo
exec jj git init

# stub opencode
chmod 755 $WORK/bin/opencode
env PATH=$WORK/bin${:}$PATH

# run opencode server
exec $II opencode serve &serve&
exec sleep 1

# run job
exec env PWD=$WORK $II job do --title 'Touch file' --type task --priority 2 --description 'In the bash tool, run touch hello-world.txt' --no-edit
stdout 'Workspace: .+'
stdout 'Session: [a-z0-9]+'
stdout 'Change: [a-z0-9]+'
stdout 'Workdir: .+'
stdout 'Todo:'
stdout '- ID: [a-z0-9]+'
stdout '- Title: Touch file'
stdout '- Type: task'
stdout '- Priority: 2 \(medium\)'
stdout '- Description:'
stdout 'In the bash tool, run touch hello-world.txt'
stdout 'Stage: implementing'
stdout 'Stage: testing'
stdout 'Stage: reviewing'
stdout 'Stage: committing'
stdout 'Commit message:'
stdout 'Test commit message'
stdout 'Refs:'
! exists hello-world.txt
! exists $WORK/hello-world.txt

-- bin/opencode --
#!/usr/bin/env python3

import os
import sys
import time


def run_serve():
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        return


def extract_workspace_root(prompt: str) -> str:
    for line in prompt.splitlines():
        if line.startswith("Workspace root:"):
            return line.split(":", 1)[1].strip()
    raise RuntimeError("workspace root missing from prompt")


def run_job(prompt: str):
    workspace_root = extract_workspace_root(prompt)
    pwd = os.environ.get("PWD", "")
    if not pwd:
        raise RuntimeError("PWD not set")
    if pwd != workspace_root:
        raise RuntimeError(f"PWD {pwd} does not match workspace root {workspace_root}")
    open(os.path.join(workspace_root, "hello-world.txt"), "a").close()
    with open(os.path.join(workspace_root, ".incrementum-commit-message"), "w") as handle:
        handle.write("Test commit message\n")


def main():
    if len(sys.argv) < 2:
        return
    cmd = sys.argv[1]
    if cmd == "serve":
        run_serve()
        return
    if cmd == "run":
        prompt = sys.argv[-1] if len(sys.argv) > 2 else ""
        run_job(prompt)
        return


if __name__ == "__main__":
    main()
