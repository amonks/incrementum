# setup repo
mkdir repo
cd repo
exec jj git init

# create history
exec jj describe -m 'change 0'
exec jj new
exec jj describe -m 'change 1'
exec jj new
exec jj describe -m 'change 2'

exec jj log -r @-- -T change_id --no-graph
envset EXPECTED_PARENT stdout

# stub opencode
chmod 755 $WORK/bin/opencode
env PATH=$WORK/bin${:}$PATH

# run opencode server
exec $II opencode serve &serve&
exec sleep 1

# run job
exec env EXPECTED_PARENT=$EXPECTED_PARENT PWD=$WORK $II job do --rev $EXPECTED_PARENT --title 'Touch file' --type task --priority 2 --description 'In the bash tool, run touch hello-world.txt' --no-edit
stdout 'Stage: implementing'
stdout 'Stage: testing'
stdout 'Stage: reviewing'
stdout 'Stage: committing'
stdout 'Commit message:'
stdout 'Test commit message'
stdout 'Refs:'
! exists hello-world.txt
! exists $WORK/hello-world.txt

-- bin/opencode --
#!/usr/bin/env python3

import os
import subprocess
import sys
import time


def run_serve():
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        return


def extract_workspace_root(prompt: str) -> str:
    for line in prompt.splitlines():
        if line.startswith("Workspace root:"):
            return line.split(":", 1)[1].strip()
    raise RuntimeError("workspace root missing from prompt")


def ensure_expected_parent(workspace_root: str):
    expected = os.environ.get("EXPECTED_PARENT", "").strip()
    if not expected:
        raise RuntimeError("EXPECTED_PARENT not set")
    actual = subprocess.check_output(
        ["jj", "log", "-r", "@-", "-T", "change_id", "--no-graph"],
        cwd=workspace_root,
    ).decode().strip()
    if actual != expected:
        raise RuntimeError(f"expected parent {expected}, got {actual}")


def run_job(prompt: str):
    workspace_root = extract_workspace_root(prompt)
    pwd = os.environ.get("PWD", "")
    if not pwd:
        raise RuntimeError("PWD not set")
    if pwd != workspace_root:
        raise RuntimeError(f"PWD {pwd} does not match workspace root {workspace_root}")
    ensure_expected_parent(workspace_root)
    open(os.path.join(workspace_root, "hello-world.txt"), "a").close()
    with open(os.path.join(workspace_root, ".incrementum-commit-message"), "w") as handle:
        handle.write("Test commit message\n")


def main():
    if len(sys.argv) < 2:
        return
    cmd = sys.argv[1]
    if cmd == "serve":
        run_serve()
        return
    if cmd == "run":
        prompt = sys.argv[-1] if len(sys.argv) > 2 else ""
        run_job(prompt)
        return


if __name__ == "__main__":
    main()
